<html>

    <head>
        <link rel="stylesheet" href="styles.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <link rel="icon" type="image/png" href="/final_logo.png">
    </head>
		
    <!--SIGNUP GOES HERE-->
    <div id="new_account" class="signup-box" style = "display: none;">
      <form action="signup-info">
      <img src="final_logo.png" alt="CHECKERS LOGO">
	  <div class="input-icon">
		<i class="fas fa-user"></i>
		<input type="text" id="signup-username" name="usr" placeholder="USERNAME" required>
		</div>

		<span id="username-error" class = "error-msg" style="display: none;">Username must be at least 4 characters.</span>
		<div class="input-icon">
		<i class="fas fa-lock"></i>
		<input type="password" id="signup-password" name="psw" placeholder="PASSWORD" required>
		</div>
		<span id="password-error" class = "error-msg" style="display: none;">Password must be at least 6 characters.</span>

		<div class="input-icon">
		<i class="fas fa-lock"></i>
		<input type="password" id="signup-confirm-password" name="psw" placeholder="CONFIRM PASSWORD" required>
		</div>
		<span id="confirm-password-error" class = "error-msg" style="display: none;">Password must be at least 6 characters.</span>

		<button id="signup-btn" type="submit">SIGN UP</button>
		<p class="signup-text">Already have an account? <a href="#" id="back-to-login">Log in</a></p>
      </form>
  	</div>
      
	<div id="login" class="login-box">
        <form action="login-info">
            <img src="final_logo.png" alt="CHECKERS LOGO">

            <div class="input-icon">
            <i class="fas fa-user"></i>
            <input type="text" id="login-username" name="usr" placeholder="USERNAME" required>
            </div>
            <span id="login-username-error" class = "error-msg" style="display: none;">Username not found. Please try again</span>

            <div class="input-icon">
            <i class="fas fa-lock"></i>
            <input type="password" id="login-password" name="psw" placeholder="PASSWORD" required>
            </div>
            <span id="login-password-error" class = "error-msg" style="display: none;">Incorrect password. Please try again</span>

            <button id="login-btn" type="submit">LOGIN</button>

            <p class="signup-text">
                Don't have an account? <a href="#" id="show-signup">Sign up</a>
            </p>
        </form>

		 <script>

				/*connection.onmessage = function(event){
				const data = JSON.parse(event.data);
				console.log("Message from server: ", data);
				if(data.responseID === "login"){
					document.elementById("login-username-error").style.display = "none";
					document.elementById("login-password-error").style.display = "none";

					if(data.msg === "Invalid password."){
						document.elementById("login-password-error").style.display = "inline";
					}
					if(data.msg === "Username does not exist."){
						document.elementById("login-username-error").style.display = "inline";
					}
					else{
						alert("Invalid username or password.");
					}
				}
				else if(data.responseID === "loginSuccess"){
					alert(data.msg);
					window.location.href = "join_game.html";
					}
				else if(data.responseID ==="new_user"){
						document.elementById("username-error").style.display = "none";
						document.elementById("password-error").style.display = "none";
						if(data.msg === "Username already exists"){
							alert("Username already Exists")
						}
						if(data.redirect === "join_game"){
							window.location.href = "join_game.html";
						}
					}
				};
				connection.onerror = function(error){
					console.error("Websocket Error: ", error);
				}
				connection.onclose = function(event){
					console.log("Websocket Closed");
				}	
					*/	

				//temporary hardcode
				/*connection.onmessage = function(event){
					const data = JSON.parse(event.data);
					console.log("Recieved data: ", data);

					if(data.responseID === "loginSuccess"){
						alert(data.msg);
						if(data.redirect === "join_game"){
							window.location.href = "join_game.html";
						}
					}
					else if(data.responseID === "new_user"){
						alert(data.msg);
						if(data.redirect === "join_game"){
							window.location.href = "join_game.html";
						}
					}
					else if(data.responseID === "login"){
						alert("Login failed: " + data.msg)
					}
				};

				document.getElementById("show-signup").onclick = function() {
					document.getElementById("login").style.display = "none";
					document.getElementById("new_account").style.display = "block";
				};

				document.getElementById("back-to-login").onclick = function() {
					document.getElementById("new_account").style.display = "none";
					document.getElementById("login").style.display = "block";
				};
				
				document.getElementById("signup-btn").onclick = function(e){
					e.preventDefault();
					
					const username = document.getElementById("signup-username").value; //username from signup form
					const password = document.getElementById("signup-password").value; //password from signup form
					const confirmPassword = document.getElementById("signup-confirm-password").value;
					//Hide error messages by default
					document.getElementById("username-error").style.display = "none";
					document.getElementById("password-error").style.display = "none";
					document.getElementById("confirm-password-error").style.display = "none";


					let valid = true;
				if(username.length < 3){
					document.getElementById("username-error").style.display = "inline";
					valid = false;
				}
				if(password.length < 5){
					document.getElementById("password-error").style.display = "inline";
					valid = false;
				}
				if(password != confirmPassword){
					document.getElementById("confirm-password-error").style.display = "inline";
					valid = false;
					return;
				}
				if(!username || !password || !confirmPassword){
				alert("All fields are required.");
				return;
			}
			if(!valid) return;
				
				const signupData = { 
					//Data into JSON object
					type: "new_user", 
					UserName : username, 
					Password:password
				};
			//Send data as JSON string JSON.stringify
			connection.send(JSON.stringify(signupData));
			console.log("Signup Data sent: ", signupData)		
			};
			//Event handler for login button
			document.getElementById("login-btn").onclick = function(e){
				e.preventDefault();

				const loginUsername = document.getElementById("login-username").value; //username from signup form
				const loginPassword = document.getElementById("login-password").value; //password from signup form

				document.getElementById("login-username-error").style.display = "none";
				document.getElementById("login-password-error").style.display = "none";
					
				// More Data Validation can go here
				if(!loginUsername || !loginPassword){ //Username or Password not filled in
					alert("Invalid username and/or password.");
					return;
				}
				const loginData = { //Data into JSON object
					type: "login", 
					UserName : loginUsername, 
					Password:loginPassword
				};
			//Send data as JSON string JSON.stringify
			connection.send(JSON.stringify(loginData))
			console.log("Login Data sent: ", loginData)		
			}
*/
		</script>
	</div>
    <div id="join_game">
		<div class="lobby_lists_container" style = "width:100%;">
			<!-- have function to get player username and/ or ID -->
			<h2>Have fun in the lobby :D</h2>
			<!-- Have function to get amount of players -->
			<h3>Current players: 3/48</h3>
			<div class="lobby_lists" style="border-radius: 2em; border: 1px solid">
				<ol id="lobby_list_items">
					<!-- Dynamically Created Elements -->
	
					<!-- UPDATE STATUS INDICATOR (CHASE) -->
	
					<!-- EXAMPLE: -->
					<!-- <li class="player">
						<p id="UID002"> Player 2 - {ELO} <span class="status free"></span></p>
						<button id="btn1-UID002" onclick="req_challenge(1,2)">Challenge</button>
						<button id="btn2-UID002" onclick="console.log('request spectate')" disabled>View Match</button>
					</li> -->
				</ol>
			</div>
	
			<button>
				<!-- Will always have current player information, parameter is player they want to challenge -->
				<!-- Challanged player must accept, timer of 10 seconds then automatic deny -->
				<a id="CURRENT_SESSION_JQ" type="button" onclick="match_making({'id':1,'name':'bob','elo':1200})">
					Match Making
				</a>
			</button>
			<!-- Will send info to DB and Bots with what bot and person -->
			<button>
				<a id="CURRENT_SESSION_BOT" type="button">
					Request Bot
				</a>
			</button>
			<!-- request to see bots play -->
			<button>
				<a id="CURRENT_SESSION_BOTvsBOT" type="button" > <!-- onclick in script section -->
					Watch Bot Vs Bot
				</a></button>
		</div>
		<!-- Send server who is the current player that logged in and request to see the list of active players-->
		<script>
			const currentPlayerInfo = {};

			function displayJoinGame(player_info) {
					// Remove JSON.parse since player_info is already an object
					const listEl = document.getElementById("lobby_list_items");

					// list item
					const li = document.createElement("li");
					li.className = "player";

					// paragraph w/ span indicator
					const paragraph = document.createElement("p");
					paragraph.id = `UID${player_info.ClientID}`;
					paragraph.innerText = `${player_info.username} - Elo: ${player_info.elo}`;

					const span = document.createElement("span");
					if (player_info.status == "ONLINE"){
						span.className = "status free"; 
					} else {
						span.className = "status busy"; 
					}
					paragraph.appendChild(span);

					// buttons
					const challenge_btn = document.createElement("button");
					challenge_btn.id = `chall_btn-${player_info.ClientID}`;
					challenge_btn.innerText = "Challenge";
					challenge_btn.onclick = function () {
						// req_challenge(1, player_info.ClientID);
						console.log("Requesting challenge to player: {player_id}");
					};

					const view_btn = document.createElement("button");
					view_btn.id = `view_btn-${player_info.ClientID}`;
					view_btn.innerText = "View Match";
					if (player_info.status == "ONLINE"){
						view_btn.disabled = true; 
					} else {
						view_btn.disabled = false; 
					}
					view_btn.disabled = true; 
					view_btn.onclick = function () {
						console.log("Requesting to spectate match");
					};
				
					li.appendChild(paragraph);
					li.appendChild(challenge_btn);
					li.appendChild(view_btn);

					listEl.appendChild(li);
			};

			function updateJoinGameList(data) {
				clearLobbyList(); 
				const current_player_id = data["MyClientID"];
				const online_players = data["activePlayers"];

				document.querySelector("#join_game h3").textContent = `Current players: ${data.playersInQueue}/48`;

				online_players.forEach(player => {
					if (player.ClientID === current_player_id) {
						Object.assign(currentPlayerInfo, player); 

						document.querySelector("#join_game h2").textContent = `Welcome back, ${player.username}! Have fun in the lobby :D`;
					} else {
						displayJoinGame(player);
					}
				});
			}

			function updateStatus(playerID, status) {
				// Access the player ID
				const playerElement = document.getElementById(playerID);

				// access the status span
				const statusElement = playerElement.querySelector('.status');
				const challengedBtn = document.getElementById(`btn1-${playerID}`);
				const viewBtn = document.getElementById(`btn2-${playerID}`);

				if (!challengedBtn) {
					console.log("cant find button");
				}
				// Change the status to "free"
				if (status == "busy") {
					statusElement.classList.remove('free');
					statusElement.classList.add('busy');

					//change challenge button to disabled, view match to True
					challengedBtn.disabled = true;
					viewBtn.disabled = false;
				}
				// welp you not gonna spectate an idle player 
				else {
					statusElement.classList.remove('busy');
					statusElement.classList.add('free');
					//change button to normal
					challengedBtn.disabled = false;
					viewBtn.disabled = true;
				}
			}

			function watchBotVsBot(player_info) {
				const botVsBotReq = {
					type: "request_bot_vs_bot",
					playerID: player_info.ClientID, 
				};

				console.log("Requesting Bot vs Bot Match:", botVsBotReq);
				connection.send(JSON.stringify(botVsBotReq));
			}

			document.getElementById("CURRENT_SESSION_BOTvsBOT").onclick = function () {
				watchBotVsBot(currentPlayerInfo); 
			};

			function clearLobbyList() {
				const listEl = document.getElementById("lobby_list_items");
				listEl.innerHTML = ""; // clear child elements
			}
		</script>
	</div>
    <div id="game_display">

    </div>
	<div class="summary">
		<button id="summary-button-display" onclick="summaryShow()">Leaderboard</button>

		<!-- visibility hidden -->
		<div id="summary-leaderboard" style="display: none;">
			<h1>Leaderboard</h1>
			<div class="scrollable-table">
			<table id="summary-table">
				<thead>
					<tr>
						<th>Rank</th>
						<th>Player</th>
						<th>Elo</th>
						<th>Games Won</th>
						<th>Games Lost</th>
						<th>Total Number of Games</th>
					</tr>
				</thead>
				<tbody>
					<!-- These data will be filled with JSON through a JS script -->
				</tbody>
			</table>
		</div>
			<!--- <p class= "caption"> Top 10 players.</p> -->
			<button id="summary-button-hide" onclick="summaryHide()">Back to Home</button>
			<script src="./summary/summary.js"></script>
			<script>
				// Temporary functions to show/hide the leaderboard until page manager can take over
				function summaryShow() {
					document.getElementById("summary-button-display").style.display = "none"; // Hide the button
					document.getElementById("summary-leaderboard").style.display = "inline-block"; // Show the leaderboard
					renderLeaderboard();
				}
				
				function summaryHide() {
					document.getElementById("summary-button-display").style.display = "inline-block"; // Show the button
					document.getElementById("summary-leaderboard").style.display = "none"; // Hide the leaderboard
				}
			</script>
		</div>
	</div>

<div id="stuff">
	<input type="button" value="Send Something" onclick="msg()">
	<label for="tbox">Received</label>
	<textarea id="tbox" name="tbox" rows="4" cols="50">
     </textarea>
</div>

</html>
<script>
	// each of the 'divs' in the html page should have attributes to allow them to be hidden.
	// the page manager should send a small json message, that tells which of these are hidden
	// and which are visible when there is a change
	// something like "{"display_new_account":t,"display_join_game":f,"display_game_display:f,"display_summary":f}"


	// a reminder.  we want to create one websocket connection, and use if, basically forever.
	// or until the user decides to go to another page.
	// this requires everything to load from this page.

	var connection = null;

	var serverUrl;
	serverUrl = "ws://" + window.location.hostname + ":" + (parseInt(location.port) + 100);
	connection = new WebSocket(serverUrl);

	connection.onopen = function (evt) {
		console.log("open");
	}

	connection.onclose = function (evt) {
		console.log("close");
	}


	connection.onmessage = function (evt) {
		let msg = evt.data; //extract data from websocket response
		console.log("Message received: " + msg);
		let jsonMsg = JSON.parse(msg); //convert data to JSON
		//Extracts the response identifier from the response, so we can determine whose code it belongs to
		//See ./INTERFACES/client-server-docs.md for details
		let responseID = Object.keys(jsonMsg)[0];
		switch (responseID) {

			// Account Responses

			// Game Responses
			case "join_game": {
				// console.log("Received thing!");
				updateJoinGameList(msg);
				break;
			} 
			case "allOnlinePlayerInfo": {
				console.log("Received thing!");
				break;
			}
			case "bot_vs_bot": {
				console.log("Recieved bot_vs_bot!");
				
				if(jsonMsg[responseID].success){
				document.getElementById("join_game").style.display = "none";
				document.getElementById("game_display").style.display = "block";

				console.log("Watching Bot vs Bot match: ", jsonMsg[responseID].matchId);
				}else{
					alert("Failed to set up Bot vs Bot Match: " + jsonMsg[responseID].message);
				}
				break;
			}

			// Summary Responses
			case "summaryTopTenData": {
				console.log("Received summaryTopTenData!");
				//ommits the responseID and only sends needed values to loadData
				loadData(jsonMsg[responseID]); 
				break;
			}
			case "summaryUserJson": {
				console.log("Received summaryUserJson!");
				break;
			}
			default: {
				console.log("Received unexpected responseID! Got: \n" + responseID);
			}
		}

		document.getElementById("tbox").innerHTML = msg + '\n' + document.getElementById("tbox").innerHTML; //what does this do??
		//const obj = JSON.parse(msg);
	}

	class UserEvent {
		msg;
	}

	function msg() {
		console.log("button clicked");
		U = new UserEvent();
		U.msg = "i pushed a button";
		connection.send(JSON.stringify(U));
		console.log(JSON.stringify(U))
	}

	
	// Function to retrieve and display the leaderboard
	function summary(/*void*/) {

		/* DEPRECATED : Code now resides in ./summary.js */

		/*
		* Fetches and displays player ranking data in the summary table.
		*
		* This function retrieves JSON data for:
		* - The current player, identified via a session UUID.
		* - The top 10 ranked players.
		*
		* The data is retrieved using:
		* - `retrieveUserJson(uuid)`: Fetches the current player's data.
		* - `retrieveTopTenJson()`: Fetches the top 10 ranked players.
		*
		* The retrieved data is then written to the HTML table inside the summary div.
		*
		* TODO:
		* - Implement a method to obtain the session UUID to call `retrieveUserJson(uuid)`.
		* - Handle potential errors when fetching data.
		* - Ensure proper table structure for displaying the data.
		*/

		// playerData = retrieveUserJson();
		// globalData = retrieveTopTenJson();

		// Write top ten to table
		// Write user to table
		return;
	}
</script>